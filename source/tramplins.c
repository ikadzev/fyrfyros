#include "headers/tramplins.h"
#include "headers/kernel_allocator.h"


extern void tramplin_00(void);
extern void tramplin_01(void);
extern void tramplin_02(void);
extern void tramplin_03(void);
extern void tramplin_04(void);
extern void tramplin_05(void);
extern void tramplin_06(void);
extern void tramplin_07(void);
extern void tramplin_08(void);
extern void tramplin_09(void);
extern void tramplin_0A(void);
extern void tramplin_0B(void);
extern void tramplin_0C(void);
extern void tramplin_0D(void);
extern void tramplin_0E(void);
extern void tramplin_0F(void);
extern void tramplin_10(void);
extern void tramplin_11(void);
extern void tramplin_12(void);
extern void tramplin_13(void);
extern void tramplin_14(void);
extern void tramplin_15(void);
extern void tramplin_16(void);
extern void tramplin_17(void);
extern void tramplin_18(void);
extern void tramplin_19(void);
extern void tramplin_1A(void);
extern void tramplin_1B(void);
extern void tramplin_1C(void);
extern void tramplin_1D(void);
extern void tramplin_1E(void);
extern void tramplin_1F(void);
extern void tramplin_20(void);
extern void tramplin_21(void);
extern void tramplin_22(void);
extern void tramplin_23(void);
extern void tramplin_24(void);
extern void tramplin_25(void);
extern void tramplin_26(void);
extern void tramplin_27(void);
extern void tramplin_28(void);
extern void tramplin_29(void);
extern void tramplin_2A(void);
extern void tramplin_2B(void);
extern void tramplin_2C(void);
extern void tramplin_2D(void);
extern void tramplin_2E(void);
extern void tramplin_2F(void);
extern void tramplin_30(void);
extern void tramplin_31(void);
extern void tramplin_32(void);
extern void tramplin_33(void);
extern void tramplin_34(void);
extern void tramplin_35(void);
extern void tramplin_36(void);
extern void tramplin_37(void);
extern void tramplin_38(void);
extern void tramplin_39(void);
extern void tramplin_3A(void);
extern void tramplin_3B(void);
extern void tramplin_3C(void);
extern void tramplin_3D(void);
extern void tramplin_3E(void);
extern void tramplin_3F(void);
extern void tramplin_40(void);
extern void tramplin_41(void);
extern void tramplin_42(void);
extern void tramplin_43(void);
extern void tramplin_44(void);
extern void tramplin_45(void);
extern void tramplin_46(void);
extern void tramplin_47(void);
extern void tramplin_48(void);
extern void tramplin_49(void);
extern void tramplin_4A(void);
extern void tramplin_4B(void);
extern void tramplin_4C(void);
extern void tramplin_4D(void);
extern void tramplin_4E(void);
extern void tramplin_4F(void);
extern void tramplin_50(void);
extern void tramplin_51(void);
extern void tramplin_52(void);
extern void tramplin_53(void);
extern void tramplin_54(void);
extern void tramplin_55(void);
extern void tramplin_56(void);
extern void tramplin_57(void);
extern void tramplin_58(void);
extern void tramplin_59(void);
extern void tramplin_5A(void);
extern void tramplin_5B(void);
extern void tramplin_5C(void);
extern void tramplin_5D(void);
extern void tramplin_5E(void);
extern void tramplin_5F(void);
extern void tramplin_60(void);
extern void tramplin_61(void);
extern void tramplin_62(void);
extern void tramplin_63(void);
extern void tramplin_64(void);
extern void tramplin_65(void);
extern void tramplin_66(void);
extern void tramplin_67(void);
extern void tramplin_68(void);
extern void tramplin_69(void);
extern void tramplin_6A(void);
extern void tramplin_6B(void);
extern void tramplin_6C(void);
extern void tramplin_6D(void);
extern void tramplin_6E(void);
extern void tramplin_6F(void);
extern void tramplin_70(void);
extern void tramplin_71(void);
extern void tramplin_72(void);
extern void tramplin_73(void);
extern void tramplin_74(void);
extern void tramplin_75(void);
extern void tramplin_76(void);
extern void tramplin_77(void);
extern void tramplin_78(void);
extern void tramplin_79(void);
extern void tramplin_7A(void);
extern void tramplin_7B(void);
extern void tramplin_7C(void);
extern void tramplin_7D(void);
extern void tramplin_7E(void);
extern void tramplin_7F(void);
extern void tramplin_80(void);
extern void tramplin_81(void);
extern void tramplin_82(void);
extern void tramplin_83(void);
extern void tramplin_84(void);
extern void tramplin_85(void);
extern void tramplin_86(void);
extern void tramplin_87(void);
extern void tramplin_88(void);
extern void tramplin_89(void);
extern void tramplin_8A(void);
extern void tramplin_8B(void);
extern void tramplin_8C(void);
extern void tramplin_8D(void);
extern void tramplin_8E(void);
extern void tramplin_8F(void);
extern void tramplin_90(void);
extern void tramplin_91(void);
extern void tramplin_92(void);
extern void tramplin_93(void);
extern void tramplin_94(void);
extern void tramplin_95(void);
extern void tramplin_96(void);
extern void tramplin_97(void);
extern void tramplin_98(void);
extern void tramplin_99(void);
extern void tramplin_9A(void);
extern void tramplin_9B(void);
extern void tramplin_9C(void);
extern void tramplin_9D(void);
extern void tramplin_9E(void);
extern void tramplin_9F(void);
extern void tramplin_A0(void);
extern void tramplin_A1(void);
extern void tramplin_A2(void);
extern void tramplin_A3(void);
extern void tramplin_A4(void);
extern void tramplin_A5(void);
extern void tramplin_A6(void);
extern void tramplin_A7(void);
extern void tramplin_A8(void);
extern void tramplin_A9(void);
extern void tramplin_AA(void);
extern void tramplin_AB(void);
extern void tramplin_AC(void);
extern void tramplin_AD(void);
extern void tramplin_AE(void);
extern void tramplin_AF(void);
extern void tramplin_B0(void);
extern void tramplin_B1(void);
extern void tramplin_B2(void);
extern void tramplin_B3(void);
extern void tramplin_B4(void);
extern void tramplin_B5(void);
extern void tramplin_B6(void);
extern void tramplin_B7(void);
extern void tramplin_B8(void);
extern void tramplin_B9(void);
extern void tramplin_BA(void);
extern void tramplin_BB(void);
extern void tramplin_BC(void);
extern void tramplin_BD(void);
extern void tramplin_BE(void);
extern void tramplin_BF(void);
extern void tramplin_C0(void);
extern void tramplin_C1(void);
extern void tramplin_C2(void);
extern void tramplin_C3(void);
extern void tramplin_C4(void);
extern void tramplin_C5(void);
extern void tramplin_C6(void);
extern void tramplin_C7(void);
extern void tramplin_C8(void);
extern void tramplin_C9(void);
extern void tramplin_CA(void);
extern void tramplin_CB(void);
extern void tramplin_CC(void);
extern void tramplin_CD(void);
extern void tramplin_CE(void);
extern void tramplin_CF(void);
extern void tramplin_D0(void);
extern void tramplin_D1(void);
extern void tramplin_D2(void);
extern void tramplin_D3(void);
extern void tramplin_D4(void);
extern void tramplin_D5(void);
extern void tramplin_D6(void);
extern void tramplin_D7(void);
extern void tramplin_D8(void);
extern void tramplin_D9(void);
extern void tramplin_DA(void);
extern void tramplin_DB(void);
extern void tramplin_DC(void);
extern void tramplin_DD(void);
extern void tramplin_DE(void);
extern void tramplin_DF(void);
extern void tramplin_E0(void);
extern void tramplin_E1(void);
extern void tramplin_E2(void);
extern void tramplin_E3(void);
extern void tramplin_E4(void);
extern void tramplin_E5(void);
extern void tramplin_E6(void);
extern void tramplin_E7(void);
extern void tramplin_E8(void);
extern void tramplin_E9(void);
extern void tramplin_EA(void);
extern void tramplin_EB(void);
extern void tramplin_EC(void);
extern void tramplin_ED(void);
extern void tramplin_EE(void);
extern void tramplin_EF(void);
extern void tramplin_F0(void);
extern void tramplin_F1(void);
extern void tramplin_F2(void);
extern void tramplin_F3(void);
extern void tramplin_F4(void);
extern void tramplin_F5(void);
extern void tramplin_F6(void);
extern void tramplin_F7(void);
extern void tramplin_F8(void);
extern void tramplin_F9(void);
extern void tramplin_FA(void);
extern void tramplin_FB(void);
extern void tramplin_FC(void);
extern void tramplin_FD(void);
extern void tramplin_FE(void);
extern void tramplin_FF(void);

static void* tramplins[] = {tramplin_00, tramplin_01, tramplin_02, tramplin_03, tramplin_04,
                            tramplin_05, tramplin_06, tramplin_07, tramplin_08, tramplin_09,
                            tramplin_0A, tramplin_0B, tramplin_0C, tramplin_0D, tramplin_0E,
                            tramplin_0F, tramplin_10, tramplin_11, tramplin_12, tramplin_13,
                            tramplin_14, tramplin_15, tramplin_16, tramplin_17, tramplin_18,
                            tramplin_19, tramplin_1A, tramplin_1B, tramplin_1C, tramplin_1D,
                            tramplin_1E, tramplin_1F, tramplin_20, tramplin_21, tramplin_22,
                            tramplin_23, tramplin_24, tramplin_25, tramplin_26, tramplin_27,
                            tramplin_28, tramplin_29, tramplin_2A, tramplin_2B, tramplin_2C,
                            tramplin_2D, tramplin_2E, tramplin_2F, tramplin_30, tramplin_31,
                            tramplin_32, tramplin_33, tramplin_34, tramplin_35, tramplin_36,
                            tramplin_37, tramplin_38, tramplin_39, tramplin_3A, tramplin_3B,
                            tramplin_3C, tramplin_3D, tramplin_3E, tramplin_3F, tramplin_40,
                            tramplin_41, tramplin_42, tramplin_43, tramplin_44, tramplin_45,
                            tramplin_46, tramplin_47, tramplin_48, tramplin_49, tramplin_4A,
                            tramplin_4B, tramplin_4C, tramplin_4D, tramplin_4E, tramplin_4F,
                            tramplin_50, tramplin_51, tramplin_52, tramplin_53, tramplin_54,
                            tramplin_55, tramplin_56, tramplin_57, tramplin_58, tramplin_59,
                            tramplin_5A, tramplin_5B, tramplin_5C, tramplin_5D, tramplin_5E,
                            tramplin_5F, tramplin_60, tramplin_61, tramplin_62, tramplin_63,
                            tramplin_64, tramplin_65, tramplin_66, tramplin_67, tramplin_68,
                            tramplin_69, tramplin_6A, tramplin_6B, tramplin_6C, tramplin_6D,
                            tramplin_6E, tramplin_6F, tramplin_70, tramplin_71, tramplin_72,
                            tramplin_73, tramplin_74, tramplin_75, tramplin_76, tramplin_77,
                            tramplin_78, tramplin_79, tramplin_7A, tramplin_7B, tramplin_7C,
                            tramplin_7D, tramplin_7E, tramplin_7F, tramplin_80, tramplin_81,
                            tramplin_82, tramplin_83, tramplin_84, tramplin_85, tramplin_86,
                            tramplin_87, tramplin_88, tramplin_89, tramplin_8A, tramplin_8B,
                            tramplin_8C, tramplin_8D, tramplin_8E, tramplin_8F, tramplin_90,
                            tramplin_91, tramplin_92, tramplin_93, tramplin_94, tramplin_95,
                            tramplin_96, tramplin_97, tramplin_98, tramplin_99, tramplin_9A,
                            tramplin_9B, tramplin_9C, tramplin_9D, tramplin_9E, tramplin_9F,
                            tramplin_A0, tramplin_A1, tramplin_A2, tramplin_A3, tramplin_A4,
                            tramplin_A5, tramplin_A6, tramplin_A7, tramplin_A8, tramplin_A9,
                            tramplin_AA, tramplin_AB, tramplin_AC, tramplin_AD, tramplin_AE,
                            tramplin_AF, tramplin_B0, tramplin_B1, tramplin_B2, tramplin_B3,
                            tramplin_B4, tramplin_B5, tramplin_B6, tramplin_B7, tramplin_B8,
                            tramplin_B9, tramplin_BA, tramplin_BB, tramplin_BC, tramplin_BD,
                            tramplin_BE, tramplin_BF, tramplin_C0, tramplin_C1, tramplin_C2,
                            tramplin_C3, tramplin_C4, tramplin_C5, tramplin_C6, tramplin_C7,
                            tramplin_C8, tramplin_C9, tramplin_CA, tramplin_CB, tramplin_CC,
                            tramplin_CD, tramplin_CE, tramplin_CF, tramplin_D0, tramplin_D1,
                            tramplin_D2, tramplin_D3, tramplin_D4, tramplin_D5, tramplin_D6,
                            tramplin_D7, tramplin_D8, tramplin_D9, tramplin_DA, tramplin_DB,
                            tramplin_DC, tramplin_DD, tramplin_DE, tramplin_DF, tramplin_E0,
                            tramplin_E1, tramplin_E2, tramplin_E3, tramplin_E4, tramplin_E5,
                            tramplin_E6, tramplin_E7, tramplin_E8, tramplin_E9, tramplin_EA,
                            tramplin_EB, tramplin_EC, tramplin_ED, tramplin_EE, tramplin_EF,
                            tramplin_F0, tramplin_F1, tramplin_F2, tramplin_F3, tramplin_F4,
                            tramplin_F5, tramplin_F6, tramplin_F7, tramplin_F8, tramplin_F9,
                            tramplin_FA, tramplin_FB, tramplin_FC, tramplin_FD, tramplin_FE,
                            tramplin_FF};



static gate_descriptor* generate_idt(){
    gate_descriptor* ans = kernel_malloc(COUNT_INTERRUPT * sizeof(gate_descriptor));
    for (i32 i = 0; i < COUNT_INTERRUPT; ++i) {
        ans[i] = generate_gate_descriptor(tramplins[i], i < 0x20 ? trap_gate : interrupt_gate, kernel);
    }
    return ans;
}

static gate_descriptor generate_gate_descriptor(void* tramplin_ptr, enum gate_type type, enum descriptor_privilege_level level) {
    gate_descriptor gate;
    gate.shift_low = (u16)tramplin_ptr;
    __asm __volatile__( ".intel_syntax noprefix\n\t"
           "mov %0, cs\n\t"
           ".att_syntax prefix\n\t"
            : "=r"(gate.selector_segment)
            );
    gate.reserve1 = 0;
    gate.gate_type = type;
    gate.reserve2 = 0;
    gate.dpl = level;
    gate.reserve3 = 1;
    gate.shift_height = (u16)((i32)tramplin_ptr >> 16);
    return gate;
}

void create_lidt() {
    gate_descriptor* descriptor = generate_idt();
    table_gate_descriptor table;
    table.size = COUNT_INTERRUPT * sizeof(gate_descriptor) - 1;
    table.address = (u32)descriptor;
    __asm__ __volatile__(
            "lidt (%0)"
            :
            : "r" (&table)
            : "memory"
            );
}

